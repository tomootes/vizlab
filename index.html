<html>
	<head>
		<title>Vizlab 1</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.0/papaparse.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
		<script src="http://code.jquery.com/ui/1.11.3/jquery-ui.js"></script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r11/Stats.min.js"></script>
		<script src="js/tsv.js"></script>
		<script src="js/marker.js"></script>
		<script src="js/controls.js"></script>
		<script src="js/connection.js"></script>
		<script src="js/controls/OrbitalControls.js"></script>

		<link rel="stylesheet" type="text/css" href="css/style.css">
		<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
	</head>
	<body>
		<!--
			<div id="loader">
				<img src="images/loading.gif" />
			</div>
		-->
		<div class="container">
			<div id="draw-controls">
				<div class="btn-group btn-group-md" role="group" aria-label="...">
					<button id="add-connection" type="button" class="btn btn-default">
						<span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>
					</button>	
					<button type="button" id="delete" class="btn btn-default">
						<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
					</button>	
				</div>

				<div class="btn-group btn-group-md" role="group" aria-label="...">
					<button type="button" class="btn btn-default" id="selected-larger">
						<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
					</button>
					<button type="button" class="btn btn-default" id="selected-smaller">	
						<span class="glyphicon glyphicon-minus" aria-hidden="true"></span>
					</button>
				</div>
				<button id="toggle-skeleton" type="button" class="btn btn-default" id="selected-smaller">	
					<span id="skeleton-icon" class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>
				</button>
			</div>
		</div>
		<div id="controls">
			<div class="container" id="controls-container">

				<div id="buttons-holder">
					<div class="btn-group btn-group-md" role="group" aria-label="...">
						<button id="slowdown-animation" type="button" class="btn btn-default">
							<span class="glyphicon glyphicon-backward" aria-hidden="true"></span>
						</button>
						<button id="play-button" type="button" class="btn btn-default">
							<span id="play-icon" class="glyphicon glyphicon-pause" aria-hidden="true"></span>
						</button>
						<button  id="speedup-animation" type="button" class="btn btn-default">
							<span class="glyphicon glyphicon-forward" aria-hidden="true"></span>
						</button>
					</div>
				</div>

				<span id="animation-speed-label">Default</span>

				<span class="iteration-label" id="iteration">Default</span>

				<div id="slider-holder">
					<div id="slider"></div>
				</div>

			</div>
		</div>

		<script>
			var SCREEN_WIDTH = window.innerWidth;
			var SCREEN_HEIGHT = window.innerHeight;

			var camera, scene, raycaster, canvasRenderer, webglRenderer;

			var container, mesh, geometry, light, plane;

			var markers = [];
			var marker_radius = 10;
			var marker_objects = [];

			var connections = [];
			var connection_radius = 10;
			var selected = [];

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

			var mouse = new THREE.Vector2(), intersected;
			var iteration = 0;
			var animation_speed = 1;

			var tsv = new Tsv('data/angry.tsv');
			var s = tsv.getFile();

			var coordinates = tsv.toArray(s, 10);

			var number_of_coordinates = ( coordinates.length - 2 );

			var selected_marker_color = "#72D874";
			var marker_color = "#000000";
			var connection_color = "#000000";
			var skeleton_visible = true;
			var paused = false;

			var stats = new Stats();
  		stats.setMode(0); // 0: fps, 1: ms

  		// align top-left
  		stats.domElement.style.position = 'absolute';
  		stats.domElement.style.left = '0px';
  		stats.domElement.style.top = '0px';

  		document.body.appendChild( stats.domElement );

			init();
			animate();

			function init(){
				initUI();

				container = document.createElement('div');
				$('body').prepend(container);

				// Setup camera 
				camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 1, 100000);
				camera.position.x = 1200;
				camera.position.y = 1000;
				camera.position.z = 300;
			 	camera.up = new THREE.Vector3( 0, 0, 1 );

			  // Create a new scene
				scene = new THREE.Scene();

				// Create grey floor
				var groundMaterial = new THREE.MeshPhongMaterial({
					color: "#ff0000"
				});
				plane = new THREE.Mesh(new THREE.PlaneGeometry(1500, 1500), groundMaterial);
				plane.receiveShadow = true;
				// scene.add(plane);

				// Setup lights and add to scene
				light = new THREE.DirectionalLight(0xdfebff, 1.75);
				light.position.set(0, 0, 250);
				light.position.multiplyScalar(1.3);
				scene.add(light);

				// Draw markers for the first line in coordinates[]
				for(var i=0;i<coordinates[0].length;i++){
					marker = new Marker(i,coordinates[0][i][0],coordinates[0][i][0],coordinates[0][i][0],25);	
					marker.draw(marker_radius);
					markers.push(marker);
					scene.add(marker.object);
				}

				// RENDERER
				webglRenderer = new THREE.WebGLRenderer({antialias : true});
				webglRenderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
				webglRenderer.setClearColor( 0xffffff, 1);
				webglRenderer.domElement.style.position = "relative";
				webglRenderer.shadowMapEnabled = true;
				webglRenderer.shadowMapSoft = true;

				// Define the controls
				controls = new THREE.OrbitControls( camera );
				controls.damping = 0.2;

				// Add raycaster 
				raycaster = new THREE.Raycaster();

				container.appendChild(webglRenderer.domElement);
				window.addEventListener('resize', onWindowResize, false);
				window.addEventListener('keydown', onKeyDown, false);
				document.addEventListener( 'mousedown', onDocumentMouseDown, false );
			}

			function animate(){	

				stats.begin();

				$('#slider').slider('value', iteration);

				// Updates markers
				for(var i = 0; i < markers.length; i++){
					markers[i].update();
				}

				// Update connections
				for(var i = 0; i < connections.length; i++){
					connections[i].update();
				}

				requestAnimationFrame(animate);

				// Update frames in interface
				$('#iteration').html(iteration + " / " + number_of_coordinates );

				// Iterate of not paused
				if(iteration < ( number_of_coordinates - animation_speed ) && paused == false){
					iteration = iteration + (1 * animation_speed );
				}

				render();

				stats.end();
			}

			function render() {
				webglRenderer.render(scene, camera);
			}

		</script>
	</body>
</html>