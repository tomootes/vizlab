<html>
	<head>
		<title>Vizlab 0.1</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.0/papaparse.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
		<script src="http://code.jquery.com/ui/1.11.3/jquery-ui.js"></script>

		<script src="js/stats.js"></script>
		<script src="js/tsv.js"></script>
		<script src="js/controls/OrbitalControls.js"></script>

		<link rel="stylesheet" type="text/css" href="css/style.css">
		<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
	</head>
	<body>

		<!--
			<div id="loader">
				<img src="images/loading.gif" />
			</div>
		-->

		<div id="controls">
			<div class="container">

				<div id="buttons-holder">
					<div class="btn-group btn-group-md" role="group" aria-label="...">
						<button type="button" class="btn btn-default">
							<span class="glyphicon glyphicon-fast-backward" aria-hidden="true"></span>
						</button>
						<button type="button" class="btn btn-default">
							<span class="glyphicon glyphicon-backward" aria-hidden="true"></span>
						</button>
						<button id="play-button" type="button" class="btn btn-default">
							<span id="play-icon" class="glyphicon glyphicon-play" aria-hidden="true"></span>
						</button>
						<button type="button" class="btn btn-default">
							<span class="glyphicon glyphicon-forward" aria-hidden="true"></span>
						</button>
						<button type="button" class="btn btn-default">
							<span class="glyphicon glyphicon-fast-forward" aria-hidden="true"></span>
						</button>
					</div>
				</div>

				<div id="slider-holder">
					<div id="slider"></div>
				</div>

			</div>
		</div>

		<script>
			var SCREEN_WIDTH = window.innerWidth;
			var SCREEN_HEIGHT = window.innerHeight;

			var camera, scene;
			var canvasRenderer, webglRenderer;

			var container, mesh, geometry, plane;
			var markers = [];

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;

			var iteration = 0;

			var tsv = new Tsv('data/waving.tsv');
			var s = tsv.getFile();
			var coordinates = tsv.toArray(s);

			var paused = false;

			init();
			
			animate();
			

			function init(){

				$( "#play-button" ).click(function() {
  				if(paused != true){
  					paused = true;
  					document.getElementById("play-icon").className = "glyphicon glyphicon-pause";
  				}else{
  					paused = false
  					document.getElementById("play-icon").className = "glyphicon glyphicon-play";
  				}
				});

				$("#slider").slider(
					{
            value:iteration,
            min: 0,
            max: ( coordinates.length -2),
            step: 1,
            slide: function( event, ui ) {
               iteration = ui.value;
            }
					}
				);

				container = document.createElement('div');
				$('body').prepend(container);

				camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 1, 100000);
				camera.position.x = 1200;
				camera.position.y = 1000;
				camera.position.z = 300;
			  camera.up = new THREE.Vector3( 0, 0, 1 );

				scene = new THREE.Scene();

				var groundMaterial = new THREE.MeshPhongMaterial({
					color: 0xdd0000
				});

				plane = new THREE.Mesh(new THREE.PlaneGeometry(1500, 1500), groundMaterial);
				plane.receiveShadow = true;
				scene.add(plane);

				// LIGHTS
				scene.add(new THREE.AmbientLight(0x666666));

				var light;

				light = new THREE.DirectionalLight(0xdfebff, 1.75);
				// light.castShadow = true;
				light.position.set(0, 0, 250);
				light.position.multiplyScalar(1.3);

				// light.castShadow = true;
				light.shadowCameraVisible = true;

				light.shadowMapWidth = 512;
				light.shadowMapHeight = 512;

				var d = 200;

				light.shadowCameraLeft = -d;
				light.shadowCameraRight = d;
				light.shadowCameraTop = d;
				light.shadowCameraBottom = -d;

				light.shadowCameraFar = 1000;
				light.shadowDarkness = 0.2;

				scene.add(light);

				drawMarker = function(color, x, y, z, radius){
					var geometry = new THREE.SphereGeometry( radius, 32, 32 );
					var material = new THREE.MeshPhongMaterial( {color: color} );
					var marker = new THREE.Mesh( geometry, material );
					marker.position.set(x,y,z);
					marker.receiveShadow = true;
					marker.castShadow = true;
					
					return marker;
				}

				var colors = [
					"green",
					"green",
					"orange",
					"orange",
					"red",
					"blue",
					"blue",
					"blue",
					"blue",
					"black",
					"black",
					"black",
					"black",
					"black",
					"black",
					"black",
					"black",
					"black",
					"black",
					"black",
					"black",
				];
				
				for(var i=0;i<coordinates[0].length;i++){
					markers[i] = drawMarker(colors[i],coordinates[0][i][0],coordinates[0][i][0],coordinates[0][i][0],25);	
					scene.add(markers[i]);
				}

				// RENDERER
				webglRenderer = new THREE.WebGLRenderer();
				webglRenderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
				webglRenderer.setClearColor( 0xffffff, 1);
				webglRenderer.domElement.style.position = "relative";
				webglRenderer.shadowMapEnabled = true;
				webglRenderer.shadowMapSoft = true;

				controls = new THREE.OrbitControls( camera );
				controls.damping = 0.2;

				container.appendChild(webglRenderer.domElement);
				window.addEventListener('resize', onWindowResize, false);
			}

			function onWindowResize() {
				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				webglRenderer.setSize(window.innerWidth, window.innerHeight);
			}

			function animate(){	

				$('#slider').slider('value', iteration);

				// Updates markers
				for(var i = 0; i < markers.length; i++){
					markers[i].position.set(coordinates[iteration][i][0], coordinates[iteration][i][1], coordinates[iteration][i][2]);
				}
				requestAnimationFrame(animate);

				render();

				if(iteration < (coordinates.length-2) && paused == false){
					iteration = iteration + 1;	
				}
			}

			function render() {
				webglRenderer.render(scene, camera);
			}

		</script>
	</body>
</html>